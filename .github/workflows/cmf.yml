name: Build Nothing Tetris Kernel Modules Only

on:
  workflow_dispatch:

jobs:
  build-modules:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout workflow repo
      - name: Checkout workflow
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential cpio curl flex git libssl-dev \
            libncurses5-dev zlib1g-dev libelf-dev dwarves \
            wget unzip xz-utils tar clang lld llvm binutils \
            python3 python3-pip openjdk-11-jdk zip

      # 3ï¸âƒ£ Clone kernel source
      - name: Clone kernel source
        run: |
          mkdir -p kernel_build
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_6.1_nothing_mt6878.git kernel_build/kernel-6.1

      # 4ï¸âƒ£ Clone device modules
      - name: Clone device modules
        run: |
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_device_modules_6.1_nothing_mt6878.git kernel_build/kernel_device_modules-6.1

      # 5ï¸âƒ£ Clone vendor kernel modules
      - name: Clone vendor kernel modules
        run: |
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_modules_nothing_mt6878.git kernel_build/vendor/mediatek/kernel_modules

      # 6ï¸âƒ£ Fix build.config paths
      - name: Fix build.config paths
        run: |
          cd kernel_build/kernel_device_modules-6.1
          cp build.config.mtk_kernel_device_modules build.config
          mkdir -p kernel_device_modules-6.1
          cp build.config.mtk_kernel_device_modules kernel_device_modules-6.1/build.config.mtk.aarch64.mgk
          echo "âœ… build.config fixed"

      # 7ï¸âƒ£ Add modified build.sh with modules_only support
      - name: Add modules_only build.sh
        run: |
          cat > kernel_build/kernel_device_modules-6.1/build.sh <<'EOF'
#!/bin/bash
set -e

MODULES_ONLY=false
if [ "$1" == "modules_only" ]; then
    MODULES_ONLY=true
fi

echo "ROOT_DIR: $PWD"
echo "DEVICE_MODULES_DIR: ."

if [ ! -f build.config ]; then
    echo "âŒ build.config not found!"
    exit 1
fi
source ./build.config

if [ "$MODULES_ONLY" = false ]; then
    echo "ðŸ”§ Building full kernel Image*..."
    # Add your original kernel build commands here if needed
else
    echo "âš¡ Modules-only mode: skipping main kernel build."
fi

# Build device modules
echo "ðŸ”§ Building device modules..."
cd kernel_device_modules-6.1
export MAKEFLAGS="${MAKEFLAGS:-"-j2"}"
export CLANG_MAX_JOBS="${CLANG_MAX_JOBS:-2"}"
bash _setup_env.sh
# Replace with your actual Bazel target for device modules
bazel build //modules:all || true

# Build vendor modules
echo "ðŸ”§ Building vendor modules..."
cd ../vendor/mediatek/kernel_modules
# Replace with your vendor module build command
bash build_vendor.sh || true

echo "âœ… Modules build finished."
EOF
          chmod +x kernel_build/kernel_device_modules-6.1/build.sh

      # 8ï¸âƒ£ Build modules only
      - name: Build kernel modules only
        run: |
          cd kernel_build/kernel_device_modules-6.1
          export MAKEFLAGS="-j2"
          export CLANG_MAX_JOBS=2
          bash build.sh modules_only

      # 9ï¸âƒ£ Collect system_dlkm.img & vendor_dlkm.img
      - name: Collect dlkm images
        run: |
          mkdir -p artifacts
          cp kernel_build/out/android14-6.1/dist/system_dlkm.img artifacts/ || true
          cp kernel_build/out/android14-6.1/dist/vendor_dlkm.img artifacts/ || true
          cd artifacts && zip -r ../kernel_modules_artifacts.zip *

      # ðŸ”Ÿ Upload artifacts
      - name: Upload kernel modules artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel_modules
          path: kernel_modules_artifacts.zip
