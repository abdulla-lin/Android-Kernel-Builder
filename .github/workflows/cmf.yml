name: Build Kernel (Kleaf Bazel)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential \
          zip curl zlib1g-dev gcc-multilib g++-multilib \
          libc6-dev-i386 libncurses5 lib32ncurses5-dev \
          x11proto-core-dev libx11-dev lib32z1-dev \
          libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
          python3 python-is-python3 openjdk-11-jdk rsync wget ca-certificates

    - name: Install repo tool
      run: |
        mkdir -p "$HOME/bin"
        curl -sS https://storage.googleapis.com/git-repo-downloads/repo > "$HOME/bin/repo"
        chmod a+x "$HOME/bin/repo"
        echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV

    - name: Init repo
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        mkdir -p kernel_build
        cd kernel_build
        repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1

    - name: Copy local manifest
      run: |
        mkdir -p kernel_build/.repo/local_manifests
        cp .github/local_manifest.xml kernel_build/.repo/local_manifests/local_manifest.xml

    - name: Repo sync
      working-directory: kernel_build
      run: repo sync -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: Build kernel (Kleaf Bazel)
      working-directory: kernel_build/kernel_device_modules-6.1
      run: |
        chmod +x build.sh
        ./build.sh

    - name: Package common artifacts
      working-directory: kernel_build
      run: |
        mkdir -p artifacts
        cp out/arch/arm64/boot/Image* artifacts/ 2>/dev/null || true
        cp out/arch/arm64/boot/*.img artifacts/ 2>/dev/null || true
        cp out/vendor_dlkm*.img artifacts/ 2>/dev/null || true
        cp -r out/lib/modules artifacts/modules 2>/dev/null || true
        zip -r kernel_artifacts.zip artifacts || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-artifacts
        path: kernel_build/kernel_artifacts.zip
