name: Tetris Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Tetris Kernel + Device Modules
    runs-on: ubuntu-22.04
    env:
      MAKEFLAGS: "-j$(nproc --all)"
      MAX_MEM: 4096

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl build-essential bc bison flex \
            lz4 libssl-dev libncurses5-dev python3 python3-pip ccache unzip \
            zip clang llvm llvm-dev lld jq repo

      - name: Initialize repo
        run: |
          mkdir android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1 --repo-rev=v2.16

      - name: Add local manifest
        run: |
          mkdir -p android-kernel/.repo/local_manifests
          cat << 'EOF' > android-kernel/.repo/local_manifests/local_manifest.xml
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote fetch="https://github.com" name="github"/>
  <remove-project name="kernel/common"/>
  <remove-project name="kernel/common-modules/virtual-device"/>
  <remove-project name="kernel/build"/>
  <project path="build/kernel" name="kernel/build" >
    <linkfile src="kleaf/bazel.sh" dest="tools/bazel" />
    <linkfile src="build_test.sh" dest="build/build_test.sh" />
    <linkfile src="config.sh" dest="build/config.sh" />
  </project>
  <project remote="github" name="Mashopy/kernel-build-bazel_mgk_rules" path="build/bazel_mgk_rules" revision="android-14-release-u3uc34.63-31-6">
    <linkfile src="BUILD.bazel" dest="BUILD" />
    <linkfile src="kleaf/bazel.WORKSPACE" dest="WORKSPACE" />
  </project>
  <project remote="github" name="NothingOSS/android_kernel_6.1_nothing_mt6878" path="kernel-6.1" revision="mt6878/Tetris/u">
    <linkfile src="build.config.constants" dest="build.config.constants" />
  </project>
  <project remote="github" name="Mashopy/android_kernel_device_modules_6.1_nothing_mt6878" path="kernel_device_modules-6.1" revision="mt6878/Tetris/u">
    <linkfile src="build.config.mtk_kernel_device_modules" dest="build.config" />
  </project>
  <project remote="github" name="NothingOSS/android_kernel_modules_nothing_mt6878" path="vendor/mediatek/kernel_modules" revision="mt6878/Tetris/u"/>
</manifest>
EOF

      - name: Repo sync
        run: |
          cd android-kernel
          repo sync -c -j$(nproc --all) --no-tags

      - name: Build device modules
        run: |
          cd android-kernel/kernel_device_modules-6.1
          chmod +x build.sh
          # Limit memory usage to prevent runner OOM
          /usr/bin/env MAKEFLAGS="-j$(nproc --all)" ./build.sh

      - name: Collect artifacts
        run: |
          ART_DIR="$GITHUB_WORKSPACE/out-artifacts"
          mkdir -p "$ART_DIR"
          cp -r android-kernel/kernel_device_modules-6.1/out/* "$ART_DIR"/ || true
          cd "$ART_DIR"
          zip -r tetris-device-modules.zip *

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tetris-device-modules
          path: out-artifacts/tetris-device-modules.zip
