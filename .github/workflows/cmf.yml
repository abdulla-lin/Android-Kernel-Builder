name: GKI 6.1 Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    name: Build GKI 6.1 Kernel + Modules
    runs-on: ubuntu-22.04
    env:
      CCACHE_COMPILERCHECK: "$CC -dumpmachine; $CC -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl build-essential bc bison flex \
            lz4 libssl-dev libncurses5-dev python3 python3-pip ccache unzip \
            zip clang llvm llvm-dev lld jq repo

      - name: Install Bazelisk
        uses: actions/setup-bazelisk@v3
        with:
          version: '6.0.0'

      - name: Clone GKI 6.1 kernel source
        run: |
          git clone --depth=1 --branch Tetris-2 \
            https://github.com/abdulla-lin/android_kernel_6.1_nothing_mt6878.git \
            $GITHUB_WORKSPACE/android-kernel

      - name: Clone device modules
        run: |
          if [ -d "$GITHUB_WORKSPACE/android-kernel/common" ]; then
            cd $GITHUB_WORKSPACE/android-kernel/common
            git clone --depth=1 -b mt6878/Tetris/u \
              https://github.com/abdulla-lin/android_kernel_device_modules_6.1_nothing_mt6878 device-modules
          fi

      - name: Clone vendor modules
        run: |
          if [ -d "$GITHUB_WORKSPACE/android-kernel/common" ]; then
            cd $GITHUB_WORKSPACE/android-kernel/common
            git clone --depth=1 -b mt6878/Tetris/u \
              https://github.com/abdulla-lin/android_kernel_modules_nothing_mt6878 vendor-modules
          fi

      - name: Build GKI kernel
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          bazel --local_ram_resources=4096 --local_cpu_resources=2 --jobs=2 \
            run //common:kernel_aarch64_dist

      - name: Build vendor modules (vendor_dlkm)
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          bazel --local_ram_resources=4096 --local_cpu_resources=2 --jobs=2 \
            run //common:vendor_dlkm

      - name: Build device modules (system_dlkm)
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          bazel --local_ram_resources=4096 --local_cpu_resources=2 --jobs=2 \
            run //common:system_dlkm

      - name: Collect artifacts
        run: |
          ART_DIR="$GITHUB_WORKSPACE/out-artifacts"
          mkdir -p "$ART_DIR"
          cd $GITHUB_WORKSPACE/android-kernel/common
          find bazel-bin/common -name "Image*" -exec cp {} "$ART_DIR"/ \;
          find bazel-bin/common -name "vmlinux*" -exec cp {} "$ART_DIR"/ \;
          find bazel-bin/common -name "*.img" -exec cp {} "$ART_DIR"/ \;
          find bazel-bin/common -name "*.ko" -exec cp {} "$ART_DIR"/ \;
          cd "$ART_DIR"
          zip -r gki-6.1-build.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gki-6.1-nothing-mt6878
          path: out-artifacts/gki-6.1-build.zip
