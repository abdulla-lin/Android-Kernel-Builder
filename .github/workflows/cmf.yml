name: Build & Verify Fenrir (Tetris)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: abdulla-lin/fenrir
          ref: main

      # 2Ô∏è‚É£ Install dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget python3 unzip binutils

      # 3Ô∏è‚É£ Ensure stock bootloader exists
      - name: Ensure bin/tetris.bin exists
        run: |
          if [ ! -f bin/tetris.bin ]; then
            echo "‚ùå ERROR: bin/tetris.bin not found! Place your LK image here."
            exit 1
          fi
          echo "‚úÖ Found stock bin/tetris.bin"
          ls -lh bin/tetris.bin

      # 4Ô∏è‚É£ Build Fenrir payload
      - name: Build Fenrir payload
        run: |
          chmod +x build.sh
          ./build.sh tetris

      # 5Ô∏è‚É£ Collect artifacts
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          # Stage3 payloads (optional)
          cp -av build/tetris/stage3/payload.elf artifacts/ 2>/dev/null || true
          cp -av build/tetris/stage3/payload.bin artifacts/ 2>/dev/null || true

          # Stock bootloader
          cp -av bin/tetris.bin artifacts/tetris-stock.bin

          # Patched bootloader (fenrir generates lk.patched)
          if [ -f lk.patched ]; then
            cp -av lk.patched artifacts/tetris-patched.bin
            echo "‚úÖ Copied lk.patched as artifacts/tetris-patched.bin"
          else
            echo "‚ùå ERROR: lk.patched not found, build failed"
            exit 1
          fi

          # Reference header
          cp -av payload/devices/tetris.h artifacts/ 2>/dev/null || true

      # 6Ô∏è‚É£ Verify fastboot patch region
      - name: Verify FASTBOOT offsets
        run: |
          set -euo pipefail
          HEADER="payload/devices/tetris.h"

          # Extract values from header
          BL2_EXT_BASE=$(grep 'BL2_EXT_BASE' "$HEADER" | awk '{print $3}')
          STAGE1_BASE=$(grep 'STAGE1_BASE' "$HEADER" | awk '{print $3}')
          FASTBOOT_REGISTER=$(grep 'FASTBOOT_REGISTER_ADDR' "$HEADER" | awk '{print $3}')
          FASTBOOT_OKAY=$(grep 'FASTBOOT_OKAY_ADDR' "$HEADER" | awk '{print $3}')

          echo "Header values:"
          echo "  BL2_EXT_BASE        = $BL2_EXT_BASE"
          echo "  STAGE1_BASE         = $STAGE1_BASE"
          echo "  FASTBOOT_REGISTER   = $FASTBOOT_REGISTER"
          echo "  FASTBOOT_OKAY       = $FASTBOOT_OKAY"

          # Convert hex to decimal (strip 0x)
          fastboot_reg_dec=$((FASTBOOT_REGISTER))
          echo "Decimal FASTBOOT_REGISTER = $fastboot_reg_dec"

          # Dump regions from stock & patched for comparison
          echo "üîé Comparing fastboot register region..."
          hexdump -C artifacts/tetris-stock.bin | head -n 20 > artifacts/stock.hex
          hexdump -C artifacts/tetris-patched.bin | head -n 20 > artifacts/patched.hex
          cmp -l artifacts/tetris-stock.bin artifacts/tetris-patched.bin > artifacts/diff.txt || true

          echo "Diff entries (if any):"
          head -n 20 artifacts/diff.txt || true

      # 7Ô∏è‚É£ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fenrir-tetris-artifacts
          path: artifacts/**
