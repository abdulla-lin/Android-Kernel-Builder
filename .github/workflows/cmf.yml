name: Build Fenrir (Tetris)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: abdulla-lin/fenrir
          ref: patch-1

      # 2️⃣ Install build dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget python3 unzip binutils

      # 3️⃣ Build Fenrir payload
      - name: Build Fenrir payload
        run: |
          chmod +x build.sh
          ./build.sh tetris

      # 4️⃣ Collect artifacts (patched LK: tetris-fenrir.bin in repo root)
      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          # Optional stage3 payloads (if produced)
          cp -av build/tetris/stage3/payload.elf artifacts/ 2>/dev/null || true
          cp -av build/tetris/stage3/payload.bin artifacts/ 2>/dev/null || true

          # ✅ Copy patched LK image from root
          if [ -f tetris-fenrir.bin ]; then
            echo "✅ Found patched bootloader: tetris-fenrir.bin"
            cp -av tetris-fenrir.bin artifacts/
          else
            echo "❌ ERROR: tetris-fenrir.bin not found in repository root after build!"
            echo "Make sure your build script writes the patched bootloader to ./tetris-fenrir.bin"
            exit 1
          fi

          # Reference header (if exists)
          cp -av payload/devices/tetris.h artifacts/ 2>/dev/null || true

          echo "✅ Artifacts collected:"
          ls -lh artifacts || true

      # 5️⃣ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fenrir-tetris-artifacts
          path: artifacts/**
