name: GKI 6.1 Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    name: Build GKI 6.1 Kernel + Modules
    runs-on: ubuntu-22.04
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      BAZEL_RAM: "--local_ram_resources=4096"
      BAZEL_CPU: "--local_cpu_resources=2"
      BAZEL_JOBS: "--jobs=2"

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl build-essential bc bison flex \
            lz4 libssl-dev libncurses5-dev python3 python3-pip ccache unzip \
            zip clang llvm llvm-dev lld jq repo

      - name: Clone Google GKI 6.1 kernel source
        run: |
          mkdir android-kernel && cd android-kernel
          repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1 --repo-rev=v2.16
          repo sync -c -j$(nproc --all) --no-tags

      - name: Clone device modules
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_device_modules_6.1_nothing_mt6878 device-modules

      - name: Clone vendor modules
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_modules_nothing_mt6878 vendor-modules

      - name: Build GKI kernel with Bazel
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          tools/bazel run $BAZEL_RAM $BAZEL_CPU $BAZEL_JOBS //common:kernel_aarch64_dist

      - name: Build vendor modules (vendor_dlkm)
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          tools/bazel run $BAZEL_RAM $BAZEL_CPU $BAZEL_JOBS //common:vendor_dlkm

      - name: Build device modules (system_dlkm)
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          tools/bazel run $BAZEL_RAM $BAZEL_CPU $BAZEL_JOBS //common:system_dlkm

      - name: Collect artifacts
        run: |
          cd $GITHUB_WORKSPACE/android-kernel/common
          mkdir -p $GITHUB_WORKSPACE/out-artifacts
          # Kernel outputs
          find bazel-bin/common -name "Image*" -exec cp {} $GITHUB_WORKSPACE/out-artifacts/ \;
          find bazel-bin/common -name "vmlinux*" -exec cp {} $GITHUB_WORKSPACE/out-artifacts/ \;
          find bazel-bin/common -name "*.img" -exec cp {} $GITHUB_WORKSPACE/out-artifacts/ \;
          # Modules (.ko)
          find bazel-bin/common -name "*.ko" -exec cp {} $GITHUB_WORKSPACE/out-artifacts/ \;
          cd $GITHUB_WORKSPACE/out-artifacts
          zip -r gki-6.1-build.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gki-6.1-nothing-mt6878
          path: out-artifacts/gki-6.1-build.zip
