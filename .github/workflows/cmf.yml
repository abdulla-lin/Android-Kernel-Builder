name: Build Kernel + Device Modules (Tetris)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        repository: abdulla-lin/android_kernel_6.1_nothing_mt6878
        ref: Tetris-2
        path: kernel_src

    - name: Checkout Device Modules
      uses: actions/checkout@v4
      with:
        repository: abdulla-lin/android_kernel_device_modules_6.1_nothing_mt6878
        ref: mt6878/Tetris/u
        path: kernel_device_modules-6.1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential cpio curl flex git libssl-dev \
          libncurses5-dev zlib1g-dev libelf-dev dwarves \
          wget unzip xz-utils tar clang lld llvm binutils python3

    - name: Build Kernel (GKI)
      run: |
        cd kernel_src
        mkdir -p out
        make O=out ARCH=arm64 gki_defconfig
        make -j$(nproc) O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1

    - name: Build Device Modules
      run: |
        cd kernel_device_modules-6.1
        export ROOT_DIR=$GITHUB_WORKSPACE/kernel_src
        export DEVICE_MODULES_DIR=$PWD
        bash build.sh

    - name: Collect artifacts
      run: |
        mkdir -p artifacts
        cp kernel_src/out/arch/arm64/boot/Image* artifacts/ || true
        cp kernel_src/out/arch/arm64/boot/dtbo.img artifacts/ || true
        cp -r kernel_src/out/modules artifacts/ || true
        cp -r kernel_device_modules-6.1/out artifacts/device_modules || true
        cd artifacts && zip -r ../kernel_modules_build.zip *

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel_modules_build
        path: kernel_modules_build.zip
