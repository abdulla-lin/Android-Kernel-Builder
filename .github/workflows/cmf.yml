name: Build Kernel (Kleaf Bazel)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential \
          zip curl zlib1g-dev gcc-multilib g++-multilib \
          libc6-dev-i386 libncurses5 lib32ncurses5-dev \
          x11proto-core-dev libx11-dev lib32z1-dev \
          libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
          python3 python-is-python3 openjdk-11-jdk rsync wget

    - name: Init repo
      run: |
        git config --global user.name "Github Actions"
        git config --global user.email "actions@github.com"
        mkdir kernel_build && cd kernel_build
        repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1

    - name: Add local manifest
      run: |
        mkdir -p kernel_build/.repo/local_manifests
        cat <<'EOF' > kernel_build/.repo/local_manifests/local_manifest.xml
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote fetch="https://github.com" name="github"/>

  <remove-project name="kernel/common"/>
  <remove-project name="kernel/common-modules/virtual-device"/>
  <remove-project name="kernel/build"/>

  <project path="build/kernel" name="kernel/build">
    <linkfile src="kleaf/bazel.sh" dest="tools/bazel"/>
    <linkfile src="build_test.sh" dest="build/build_test.sh"/>
    <linkfile src="config.sh" dest="build/config.sh"/>
  </project>

  <project remote="github" name="Mashopy/kernel-build-bazel_mgk_rules" path="build/bazel_mgk_rules" revision="android-14-release-u3uc34.63-31-6">
    <linkfile src="BUILD.bazel" dest="BUILD"/>
    <linkfile src="kleaf/bazel.WORKSPACE" dest="WORKSPACE"/>
  </project>

  <project remote="github" name="NothingOSS/android_kernel_6.1_nothing_mt6878" path="kernel-6.1" revision="mt6878/Tetris/u">
    <linkfile src="build.config.constants" dest="build.config.constants"/>
  </project>

  <project remote="github" name="Mashopy/android_kernel_device_modules_6.1_nothing_mt6878" path="kernel_device_modules-6.1" revision="mt6878/Tetris/u">
    <linkfile src="build.config.mtk_kernel_device_modules" dest="build.config"/>
  </project>

  <project remote="github" name="NothingOSS/android_kernel_modules_nothing_mt6878" path="vendor/mediatek/kernel_modules" revision="mt6878/Tetris/u"/>
</manifest>
EOF

    - name: Repo sync
      working-directory: kernel_build
      run: repo sync -j$(nproc) --force-sync --no-tags --no-clone-bundle

    - name: Build kernel (Kleaf Bazel)
      working-directory: kernel_build/kernel_device_modules-6.1
      run: |
        chmod +x build.sh
        ./build.sh

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: kernel-build
        path: kernel_build/out/**
