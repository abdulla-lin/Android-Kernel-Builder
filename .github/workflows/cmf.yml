name: Build CMF Phone 1 Kernel (kleaf GKI)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo (manifest)
      uses: actions/checkout@v4
      with:
        repository: abdulla-lin/android_kernel_6.1_nothing_mt6878
        ref: Tetris-2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential cpio curl flex git libssl-dev \
          libncurses5-dev zlib1g-dev libelf-dev dwarves \
          wget unzip xz-utils tar clang lld llvm binutils \
          python3 python3-pip

    - name: Setup Bazelisk
      run: |
        sudo curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.19.0/bazelisk-linux-amd64 -o /usr/local/bin/bazel
        sudo chmod +x /usr/local/bin/bazel
        bazel version

    - name: Configure environment
      run: |
        echo "BUILD_CONFIG=kernel-6.1/build.config.constants" >> $GITHUB_ENV
        echo "OUT_DIR=out" >> $GITHUB_ENV
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV

    - name: Build kernel (kleaf)
      run: |
        bazel build --config=fast --config=local --jobs=$(nproc) \
          //common:kernel_aarch64_dist

    - name: Collect artifacts
      run: |
        mkdir -p dist
        cp -v bazel-bin/common/kernel_aarch64/Image.gz dist/ || true
        cp -v bazel-bin/common/kernel_aarch64/*.img dist/ || true
        cp -v bazel-bin/common/kernel_aarch64/*.tar.gz dist/ || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CMF_Phone1-kleaf-GKI
        path: dist/*
