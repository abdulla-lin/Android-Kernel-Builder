name: Build Fenrir Tetris with Diagnostics

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        repository: abdulla-lin/fenrir
        ref: main

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential wget python3 unzip binutils

    - name: Prepare bin folder
      run: |
        mkdir -p bin
        rm -f bin/tetris.bin

    - name: Download stock bootloader
      run: |
        FILEID="1ZuX0hBB9fSZ7I7tDj3l0n1qrM1-KzUa1"
        CONFIRM=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate \
          "https://drive.google.com/uc?export=download&id=${FILEID}" -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1/p')
        wget --load-cookies /tmp/cookies.txt \
          "https://drive.google.com/uc?export=download&confirm=${CONFIRM}&id=${FILEID}" \
          -O bin/tetris.bin
        ls -lh bin/tetris.bin

    - name: Verify stock bootloader
      run: |
        echo "==== Stock bootloader diagnostics ===="
        hexdump -C bin/tetris.bin | head -n 20
        # Optional: print first few bytes or known offset for STAGE1_BASE
        # This is illustrative; you can add your actual offsets if known

    - name: Build & inject payload
      run: |
        chmod +x build.sh
        ./build.sh tetris

    - name: Verify injected bootloader
      run: |
        echo "==== Injected bootloader diagnostics ===="
        hexdump -C bin/tetris.bin | head -n 20
        # Optional: check STAGE1_BASE, max-download-size
        # For example:
        # dd if=bin/tetris.bin bs=1 skip=<offset> count=8 2>/dev/null | xxd

    - name: Collect artifacts
      run: |
        mkdir -p artifacts
        cp -av bin/tetris.bin artifacts/
        cp -av payload/devices/tetris.h artifacts/
        ls -lh artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fenrir-tetris-injected
        path: artifacts/**
        
