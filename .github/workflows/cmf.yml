name: Build Fenrir (Tetris)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: abdulla-lin/fenrir
          ref: main

      # 2️⃣ Install dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget python3 unzip binutils

      # 3️⃣ Ensure correct bootloader exists
      - name: Ensure bin/tetris.bin exists
        run: |
          if [ ! -f bin/tetris.bin ]; then
            echo "❌ ERROR: bin/tetris.bin not found! Place your LK image here."
            exit 1
          fi
          echo "✅ bin/tetris.bin found"
          ls -lh bin/tetris.bin

      # 4️⃣ Inspect header values
      - name: Inspect critical offsets
        run: |
          set -euo pipefail
          HEADER="payload/devices/tetris.h"

          echo "Header values:"
          grep -E 'BASE|ADDR' "$HEADER" | while read -r line; do
            name=$(echo "$line" | awk '{print $2}')
            value=$(echo "$line" | awk '{print $3}')
            echo "  $name = $value"
          done

          # helper: convert hex to decimal safely
          to_dec() {
            python3 -c "import sys; s=sys.argv[1]; print(int(s,0))" "$1"
          }

          BL2_EXT_BASE=0xFFFF000050700000
          FASTBOOT_REGISTER_ADDR=0xFFFF0000507078DC
          FASTBOOT_OKAY_ADDR=0xFFFF000050707C6C
          STAGE1_BASE=0xFFFF000050777F60

          echo "Decimal conversions:"
          echo "  BL2_EXT_BASE         = $(to_dec $BL2_EXT_BASE)"
          echo "  FASTBOOT_REGISTER    = $(to_dec $FASTBOOT_REGISTER_ADDR)"
          echo "  FASTBOOT_OKAY        = $(to_dec $FASTBOOT_OKAY_ADDR)"
          echo "  STAGE1_BASE          = $(to_dec $STAGE1_BASE)"

      # 5️⃣ Build Fenrir payload
      - name: Build Fenrir payload
        run: |
          chmod +x build.sh
          ./build.sh tetris

      # 6️⃣ Collect artifacts including patched bootloader
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          # Stage3 payloads (optional)
          cp -av build/tetris/stage3/payload.elf artifacts/ 2>/dev/null || true
          cp -av build/tetris/stage3/payload.bin artifacts/ 2>/dev/null || true
          # Patched bootloader
          if [ -f lk.patched ]; then
            cp -av lk.patched artifacts/tetris-patched.bin
            echo "✅ Patched bootloader copied as artifacts/tetris-patched.bin"
          else
            echo "⚠️ WARNING: lk.patched not found, check build logs"
          fi
          # Reference header
          cp -av payload/devices/tetris.h artifacts/ 2>/dev/null || true

      # 7️⃣ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fenrir-tetris-artifacts
          path: artifacts/**
