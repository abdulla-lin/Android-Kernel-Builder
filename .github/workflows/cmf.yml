name: Build fenrir (tetris) with diagnostic pre-check

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: abdulla-lin/fenrir
          ref: main

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget python3 unzip binutils

      - name: Download lk.img -> bin/tetris.bin
        run: |
          mkdir -p bin payload/devices artifacts
          FILEID="1ZuX0hBB9fSZ7I7tDj3l0n1qrM1-KzUa1"
          CONFIRM=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate \
            "https://drive.google.com/uc?export=download&id=${FILEID}" -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1/p')
          wget --load-cookies /tmp/cookies.txt \
            "https://drive.google.com/uc?export=download&confirm=${CONFIRM}&id=${FILEID}" \
            -O bin/tetris.bin
          ls -lh bin/tetris.bin

      - name: Diagnostic:dump Fenrir memory range
        run: |
          # Read JSON values
          JSON_BASE=$(python3 -c "import json; j=json.load(open('payload/devices/tetris.json')); print(j['bl2_ext_base'])")
          JSON_SIZE=$(python3 -c "import json; j=json.load(open('payload/devices/tetris.json')); print(j['bl2_ext_size'])")

          # Convert to decimal
          BASE=$((JSON_BASE))
          SIZE=$((JSON_SIZE))
          END=$((BASE + SIZE - 1))

          # Extract STAGE1_BASE from header
          HFILE="payload/devices/tetris.h"
          STAGE1=$(( $(awk '/#define STAGE1_BASE/ {print $3; exit}' $HFILE) ))

          # Print computed ranges
          printf "==== Fenrir Diagnostic ====\n"
          printf "BL2_EXT_BASE: 0x%X\n" $BASE
          printf "BL2_EXT_SIZE: 0x%X\n" $SIZE
          printf "Computed END: 0x%X\n" $END
          printf "STAGE1_BASE: 0x%X\n" $STAGE1
          printf "Payload size: $(stat -c%s build/tetris/stage3/payload.bin) bytes\n"

          # Check manually
          if (( STAGE1 >= BASE && STAGE1 <= END )); then
            echo "✅ STAGE1_BASE is inside JSON range"
          else
            echo "❌ STAGE1_BASE is outside JSON range"
            exit 1
          fi

      - name: Build fenrir for tetris
        run: |
          chmod +x build.sh
          ./build.sh tetris

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp -av out/* artifacts/ || true
          cp -av build/tetris/stage3/payload.elf artifacts/ || true
          cp -av payload/devices/tetris.json artifacts/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fenrir-tetris-artifacts
          path: artifacts/**
          
