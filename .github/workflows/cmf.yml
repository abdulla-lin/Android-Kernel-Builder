name: Build Nothing Tetris Kernel Modules

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout workflow repo
      - name: Checkout workflow
        uses: actions/checkout@v4

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential cpio curl flex git libssl-dev \
            libncurses5-dev zlib1g-dev libelf-dev dwarves \
            wget unzip xz-utils tar clang lld llvm binutils \
            python3 python3-pip openjdk-11-jdk zip

      # 3️⃣ Clone kernel source
      - name: Clone kernel source
        run: |
          mkdir -p kernel_build
          git clone --depth=1 -b Tetris-2 https://github.com/abdulla-lin/android_kernel_6.1_nothing_mt6878.git kernel_build/kernel-6.1

      # 4️⃣ Clone kernel device modules
      - name: Clone device modules
        run: |
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_device_modules_6.1_nothing_mt6878.git kernel_build/kernel_device_modules-6.1

      # 5️⃣ Clone vendor kernel modules
      - name: Clone vendor kernel modules
        run: |
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_modules_nothing_mt6878.git kernel_build/vendor/mediatek/kernel_modules

      # 6️⃣ Build modules only
      - name: Build kernel modules
        run: |
          cd kernel_build/kernel-6.1
          export MAKEFLAGS="-j2"
          tools/bazel build --jobs=2 //common-modules:all

      # 7️⃣ Collect artifacts
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp -r bazel-bin/common-modules/* artifacts/ || true
          cd artifacts && zip -r ../kernel_modules.zip *

      # 8️⃣ Upload kernel modules
      - name: Upload kernel modules
        uses: actions/upload-artifact@v4
        with:
          name: kernel_modules
          path: kernel_modules.zip
