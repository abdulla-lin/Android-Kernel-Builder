name: Build Nothing Tetris Kernel (Kleaf)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
    env:
      WORKDIR: ${{ github.workspace }}

    steps:
      - name: Checkout device modules repo
        uses: actions/checkout@v4

      - name: Clone kernel and vendor modules
        run: |
          set -eux
          git clone --depth=1 -b Tetris-2 https://github.com/abdulla-lin/android_kernel_6.1_nothing_mt6878.git kernel-6.1
          mkdir -p vendor/mediatek
          git clone --depth=1 -b mt6878/Tetris/u https://github.com/abdulla-lin/android_kernel_modules_nothing_mt6878.git vendor/mediatek/kernel_modules
          ln -s kernel-6.1 kernel- || true

      - name: Install Bazelisk (user-space)
        run: |
          set -eux
          curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.20.0/bazelisk-linux-amd64 -o bazel
          chmod +x bazel
          echo "$PWD" >> $GITHUB_PATH

      - name: Bazel cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-${{ runner.os }}-${{ hashFiles('**/WORKSPACE', '**/*.bzl', '**/BUILD*') }}
          restore-keys: |
            bazel-${{ runner.os }}-

      - name: Prepare repo Bazel wrapper (optional)
        run: |
          set -eux
          if [ -x ./build/bazel/prepare.sh ]; then
            ./build/bazel/prepare.sh || true
          fi

      - name: Build dist target (Kleaf)
        run: |
          set -eux
          if [ -x ./build/bazel/bin/bazelisk ]; then
            ./build/bazel/bin/bazelisk build //common:dist --config=fast
          else
            ./bazel build //common:dist --config=fast
          fi

      - name: Locate and package artifacts
        run: |
          set -eux
          mkdir -p artifacts
          # Probe common Kleaf dist locations
          find "$PWD" -maxdepth 6 -type d -name dist -print || true
          cp -v out/**/dist/Image* artifacts/ 2>/dev/null || true
          cp -v out/**/dist/*.img artifacts/ 2>/dev/null || true
          cp -rv out/**/dist/modules artifacts/ 2>/dev/null || true
          # Some trees place outputs under kernel-6.1/out
          cp -v kernel-6.1/out/**/dist/Image* artifacts/ 2>/dev/null || true
          cp -v kernel-6.1/out/**/dist/*.img artifacts/ 2>/dev/null || true
          cp -rv kernel-6.1/out/**/dist/modules artifacts/ 2>/dev/null || true
          cd artifacts && zip -r ../kernel_artifacts.zip . || true
          echo "Zipped at $PWD/../kernel_artifacts.zip"

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel_artifacts
          path: |
            kernel_artifacts.zip
            artifacts/**
          if-no-files-found: warn
