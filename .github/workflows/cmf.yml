name: Build Fenrir (tetris) directly from tetris.h

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: abdulla-lin/fenrir
          ref: main

      # 2️⃣ Install dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget python3 unzip binutils

      # 3️⃣ Ensure bootloader image exists
      - name: Verify bootloader
        run: |
          if [ ! -f "bin/tetris.bin" ]; then
            echo "ERROR: bin/tetris.bin not found. Place your LK image here."
            exit 1
          fi
          ls -lh bin/tetris.bin

      # 4️⃣ Pre-check: Verify STAGE1_BASE is valid
      - name: Pre-check STAGE1_BASE
        run: |
          HEADER="payload/devices/tetris.h"
          if [ ! -f "$HEADER" ]; then
            echo "ERROR: tetris.h not found at $HEADER"
            exit 1
          fi

          STAGE1=$(awk '/#define STAGE1_BASE/ {print $3; exit}' "$HEADER")
          STAGE2=$(awk '/#define STAGE2_BASE/ {print $3; exit}' "$HEADER")
          STAGE3=$(awk '/#define STAGE3_BASE/ {print $3; exit}' "$HEADER")

          # Convert hex to decimal safely
          STAGE1_DEC=$((16#${STAGE1#0x}))
          STAGE2_DEC=$((16#${STAGE2#0x}))
          STAGE3_DEC=$((16#${STAGE3#0x}))

          echo "STAGE1_BASE: $STAGE1 ($STAGE1_DEC)"
          echo "STAGE2_BASE: $STAGE2 ($STAGE2_DEC)"
          echo "STAGE3_BASE: $STAGE3 ($STAGE3_DEC)"

          # Basic sanity check
          if (( STAGE1_DEC > STAGE2_DEC || STAGE2_DEC > STAGE3_DEC )); then
            echo "ERROR: Stage base addresses are inconsistent"
            exit 1
          fi
          echo "✅ Stage addresses look sane"

      # 5️⃣ Build Fenrir
      - name: Build Fenrir payload
        run: |
          chmod +x build.sh
          ./build.sh tetris

      # 6️⃣ Collect artifacts
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp -av out/* artifacts/ || true
          cp -av build/tetris/stage3/payload.elf artifacts/ || true
          cp -av payload/devices/tetris.h artifacts/ || true

      # 7️⃣ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fenrir-tetris-artifacts
          path: artifacts/**
          
