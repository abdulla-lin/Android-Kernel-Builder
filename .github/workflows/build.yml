name: Build CMF Phone 1 Kernel (NDK r27b)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y git wget curl build-essential bc bison flex libssl-dev \
          libncurses5-dev libncursesw5-dev python3 python3-pip zip unzip ccache

    - name: Download & Extract NDK r27b
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r27b-linux.zip
        unzip android-ndk-r27b-linux.zip
        mv android-ndk-r27b ndk

    - name: Set Build Vars
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export PATH=$GITHUB_WORKSPACE/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_ARM32=arm-linux-androideabi-

    - name: Build Kernel
      run: |
        mkdir -p out build
        # Load defconfig
        make -C $GITHUB_WORKSPACE O=$GITHUB_WORKSPACE/out \
          gki_defconfig \
          CC=$GITHUB_WORKSPACE/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang
        # Apply any missing defaults
        make -C $GITHUB_WORKSPACE O=$GITHUB_WORKSPACE/out \
          olddefconfig \
          CC=$GITHUB_WORKSPACE/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang
        # Build kernel
        make -C $GITHUB_WORKSPACE O=$GITHUB_WORKSPACE/out \
          -j$(nproc) \
          CC=$GITHUB_WORKSPACE/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang
        # Copy kernel image
        cp $GITHUB_WORKSPACE/out/arch/arm64/boot/Image $GITHUB_WORKSPACE/build/

    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Image
        path: build/Image
