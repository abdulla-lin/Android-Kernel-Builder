name: Build GKI Kernel (Image Only)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Kernel

    env:
      ARCH: arm64
      LOCALVERSION: -NeutronClang
      KBUILD_BUILD_USER: github
      KBUILD_BUILD_HOST: actions

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v3
      with:
        repository: abdulla-lin/android_kernel_6.1_nothing_mt6878
        ref: main
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang lld llvm libelf-dev zlib1g-dev libncurses-dev \
          python3 git bc flex bison zip

    - name: Setup Neutron-Clang Toolchain
      run: |
        mkdir -p $HOME/toolchains/neutron-clang
        cd $HOME/toolchains/neutron-clang
        curl -LO "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman"
        chmod +x antman
        bash antman -S

    - name: Set Environment Variables
      run: |
        echo "PATH=$HOME/toolchains/neutron-clang/bin:$PATH" >> $GITHUB_ENV

    - name: Configure Kernel (GKI)
      run: |
        rm -rf out build
        mkdir -p out build
        make -C $GITHUB_WORKSPACE O=$GITHUB_WORKSPACE/out gki_defconfig
        make -C $GITHUB_WORKSPACE O=$GITHUB_WORKSPACE/out olddefconfig

    - name: Build Kernel Image (skip BPF)
      run: |
        make -C $GITHUB_WORKSPACE O=$GITHUB_WORKSPACE/out Image KBUILD_IGNORE_BTF=1 -j$(nproc)
        cp out/arch/arm64/boot/Image build/

    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image
        path: build/Image
        
