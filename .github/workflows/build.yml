name: Build Kernel for CMF Phone 1

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v3
        with:
          repository: abdulla-lin/android_kernel_6.1_nothing_mt6878
          ref: main

      - name: Set up Neutron Clang
        uses: rom-builders/setup-clang@v1
        with:
          clang_version: '16.0.0'

      - name: Set up GNU Toolchain
        uses: rom-builders/setup-toolchain@v1
        with:
          gcc_version: '12'

      - name: Apply Device Defconfig
        run: |
          make O=out mt6878_defconfig

      - name: Build Kernel
        run: |
          make -j$(nproc) O=out

      - name: Prepare AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp out/arch/arm64/boot/Image.gz AnyKernel3/
          cp out/arch/arm64/boot/dts/mediatek/mt6878-evb.dtb AnyKernel3/

      - name: Package Kernel with AnyKernel3
        run: |
          cd AnyKernel3
          ./tools/ak3-gen.sh
          mv AnyKernel3.zip ../kernel.zip

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v3
        with:
          name: kernel-zip
          path: kernel.zip
