name: Build GKI Kernel (android14-6.1.68)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clone Google GKI 6.1.68 Kernel Source
        run: |
          git clone --depth=1 \
            https://android.googlesource.com/kernel/common \
            -b android14-6.1.68_r00 kernel
          echo "KERNEL_DIR=$(pwd)/kernel" >> $GITHUB_ENV

      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libncurses5-dev libssl-dev zip curl

      - name: Setup ARM64 Toolchain
        run: |
          mkdir -p $HOME/toolchains
          cd $HOME/toolchains
          curl -LO https://github.com/ravindu644/Android-Kernel-Tutorials/releases/download/toolchains/arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
          tar -xf arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
          echo "PATH=$HOME/toolchains/arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu/bin:$PATH" >> $GITHUB_ENV

      - name: Optional Modify Kernel (Insert Patches)
        run: |
          cd $KERNEL_DIR
          # Example: sed -i 's/# CONFIG_DEBUG_INFO is not set/CONFIG_DEBUG_INFO=y/' arch/arm64/configs/gki_defconfig
          # Add other sed or patch commands as needed

      - name: Build Kernel
        run: |
          cd $KERNEL_DIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-none-linux-gnu-
          mkdir -p out
          make O=out gki_defconfig
          make -j$(nproc) O=out

      - name: Package with AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cp $KERNEL_DIR/out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          zip -r9 ../gki-kernel-6.1.68.zip ./*

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v3
        with:
          name: gki-kernel-6.1.68
          path: gki-kernel-6.1.68.zip
