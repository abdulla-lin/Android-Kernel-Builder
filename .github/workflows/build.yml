name: Build Android Kernel with NDK r27b Toolchain

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare Toolchain
        run: |
          mkdir -p $GITHUB_WORKSPACE/prebuilts/clang/host/linux-x86
          cd $GITHUB_WORKSPACE/prebuilts/clang/host/linux-x86
          echo "Downloading Android NDK r27b..."
          curl -LO https://dl.google.com/android/repository/android-ndk-r27b-linux.zip
          unzip -q android-ndk-r27b-linux.zip
          # Symlink clang from the NDK's LLVM directory
          ln -s $(pwd)/android-ndk-r27b/toolchains/llvm/prebuilt/linux-x86_64 ./clang-ndk
          ls -lah ./clang-ndk

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex git make \
            libncurses5-dev libssl-dev ccache \
            unzip zip curl wget

      - name: Build Kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH=$GITHUB_WORKSPACE/prebuilts/clang/host/linux-x86/clang-ndk/bin:$PATH
          export CC=clang
          echo "Using Clang version:"
          clang --version
          make O=out ARCH=arm64 <your_defconfig_here>
          make -j$(nproc) O=out ARCH=arm64 CC=clang

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: out/arch/arm64/boot/Image.gz-dtb
