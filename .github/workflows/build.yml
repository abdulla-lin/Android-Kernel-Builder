name: Build Infinity-X ROM for Nothing Tetris

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      USE_CCACHE: 1
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      # 1Ô∏è‚É£ Checkout workflow repo (optional)
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget curl zip unzip bc bison flex build-essential \
            libncurses5-dev libssl-dev ccache python3 python3-pip openjdk-17-jdk

      # 3Ô∏è‚É£ Install repo tool
      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "export PATH=$HOME/bin:$PATH" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Restore ccache cache
      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/*.mk') }}

      # 5Ô∏è‚É£ Initialize Infinity-X source
      - name: Initialize Infinity-X source
        run: |
          mkdir -p infinity_source
          cd infinity_source
          repo init -u https://github.com/ProjectInfinity-X/manifest -b 16 --git-lfs --no-repo-verify
          repo sync -c --no-tags --depth=1

      # 6Ô∏è‚É£ Clone device, kernel, and vendor trees
      - name: Clone device trees
        run: |
          cd infinity_source
          git clone --depth=1 -b infinity-16 https://github.com/abdulla-lin/android_device_nothing_tetris device/nothing/tetris
          git clone --depth=1 -b lineage-22.2 https://github.com/abdulla-lin/android_device_nothing_tetris-kernel kernel/nothing/tetris
          git clone --depth=1 -b a15 https://gitlab.com/achugaming512/android_vendor_nothing_tetris vendor/nothing/tetris

      # 7Ô∏è‚É£ Setup build environment
      - name: Setup environment
        run: |
          cd infinity_source
          source build/envsetup.sh
          lunch infinity_tetris-userdebug

      # 8Ô∏è‚É£ Copy prebuilt kernel (optional)
      - name: Copy prebuilt kernel
        run: |
          cd infinity_source
          cp -r kernel/nothing/tetris/prebuilt/* out/target/product/tetris/ || true

      # 9Ô∏è‚É£ Build ROM
      - name: Build ROM
        run: |
          cd infinity_source
          make -j$(nproc) bacon

      # üîü Save ccache for next build
      - name: Save ccache
        uses: actions/cache@v3
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/*.mk') }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload ROM artifact
      - name: Upload ROM artifact
        uses: actions/upload-artifact@v4
        with:
          name: Infinity-Tetris-ROM
          path: infinity_source/out/target/product/tetris/*.zip
