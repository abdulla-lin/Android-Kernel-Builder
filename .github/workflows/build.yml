name: Build CMF Kernel (Android14-6.1)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout Your Kernel Source
        uses: actions/checkout@v4
        with:
          repository: abdulla-lin/android_kernel_6.1_nothing_mt6878
          ref: main  # or specify a tag/branch if needed

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex libssl-dev libncurses5-dev \
            build-essential ccache wget tar zstd

      - name: Download Google Clang 17.0.2
        run: |
          wget "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/refs/heads/android14-release/clang-r487747c?format=TEXT" \
            -O clang.b64
          mkdir clang
          base64 --decode clang.b64 | tar -xzf - -C clang
          
      - name: Clone Android GKI Common Tree (for headers/modules)
        run: |
          git clone --depth=1 \
            https://android.googlesource.com/kernel/common \
            -b android14-6.1-2024-04_r1 common-gki

      - name: Build Kernel (Using GKI Defconfig)
        env:
          PATH: ${{ github.workspace }}/clang/bin:${{ env.PATH }}
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export CROSS_COMPILE=aarch64-linux-gnu-  
          mkdir -p out
          
          # Using the GKI defconfig from your CMF tree
          make O=out gki_defconfig
          
          # Build with LTO and optimizations (matches Android defaults)
          make O=out -j$(nproc) LLVM=1 CLANG_TRIPLE=aarch64-linux-gnu-

      - name: Upload Built Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cmf-kernel-image
          path: |
            out/arch/arm64/boot/Image*
            out/arch/arm64/boot/dtb
            out/arch/arm64/boot/Image.gz-dtb
