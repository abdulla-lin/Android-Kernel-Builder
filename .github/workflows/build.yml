name: Build Android Kernel (GNU 14.2 - GKI Defconfig)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget unzip make python3 gcc g++ bc libncurses5-dev flex bison libssl-dev

      - name: Download GNU 14.2 Toolchain
        run: |
          wget https://github.com/ravindu644/Android-Kernel-Tutorials/releases/download/toolchains/arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
          tar -xf arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
          mv arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu gnu-toolchain

      - name: Build Kernel (GKI Defconfig)
        run: |
          export PATH=$GITHUB_WORKSPACE/gnu-toolchain/bin:$PATH
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-none-linux-gnu-
          mkdir -p out
          make O=out gki_defconfig
          make -j$(nproc) O=out

      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            out/arch/arm64/boot/Image.gz
            out/arch/arm64/boot/dtbo.img
            out/arch/arm64/boot/dtb.img
