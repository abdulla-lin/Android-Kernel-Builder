name: Android Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v3

    - name: Setup Clang Toolchain
      run: |
        wget https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.2/clang+llvm-17.0.2-x86_64-linux-gnu-ubuntu-22.04.tar.xz
        tar -xf clang+llvm-17.0.2-x86_64-linux-gnu-ubuntu-22.04.tar.xz
        mv clang+llvm-17.0.2-x86_64-linux-gnu-ubuntu-22.04 clang-17
        echo "$GITHUB_WORKSPACE/clang-17/bin" >> $GITHUB_PATH

    - name: Build Kernel + DTB
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump
        export STRIP=llvm-strip

        make O=out ARCH=arm64 gki_defconfig
        make -j$(nproc) O=out ARCH=arm64
        make -j$(nproc) O=out ARCH=arm64 dtbs

    - name: Prepare AnyKernel3
      run: |
        git clone --depth=1 https://github.com/WildPlusKernel/AnyKernel3.git AnyKernel3
        cp out/arch/arm64/boot/Image.gz AnyKernel3/
        cp out/arch/arm64/boot/dtb.img AnyKernel3/ || true
        cd AnyKernel3
        zip -r9 ../AnyKernel3-Kernel.zip *

    - name: Upload Kernel Zip
      uses: actions/upload-artifact@v3
      with:
        name: AnyKernel3-Kernel
        path: AnyKernel3-Kernel.zip
