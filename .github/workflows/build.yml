name: Build Nothing Tetris ROM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      USE_CCACHE: 1
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout ROM source
        uses: actions/checkout@v4
        with:
          repository: username/custom_rom_repo   # Replace with your ROM repo
          ref: main

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget curl zip unzip bc bison flex build-essential \
            libncurses5-dev libssl-dev ccache python3 python3-pip openjdk-17-repo

      - name: Setup repo
        run: |
          repo init -u https://android.googlesource.com/platform/manifest -b android14
          repo sync -c --no-tags --depth=1

      - name: Clone device trees
        run: |
          git clone --depth=1 https://github.com/SuperAviation001/android_device_nothing_tetris device/nothing/tetris
          git clone --depth=1 https://github.com/SuperAviation001/android_device_nothing_tetris-kernel kernel/nothing/tetris
          git clone --depth=1 https://gitlab.com/SuperAviation001/android_vendor_nothing_tetris vendor/nothing/tetris

      - name: Setup environment
        run: |
          source build/envsetup.sh
          lunch aosp_tetris-userdebug

      - name: Copy prebuilt kernel
        run: |
          cp -r kernel/nothing/tetris/prebuilt/* out/target/product/tetris/

      - name: Build ROM
        run: |
          make -j$(nproc) bacon

      - name: Upload built ROM
        uses: actions/upload-artifact@v4
        with:
          name: Nothing-Tetris-ROM
          path: out/target/product/tetris/*.zip
